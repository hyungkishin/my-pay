### Async 통신의 한계

- 특정 상황들에서는 필연적으로 두 번 이상 데이터를 받을 가능성 존재
- Async 통신의 장점이 명확하고, 사용하기에 매우 적절한 경우들이 존재하나 한계 존재
    - logging pipeline, UX 상 빠른 리턴 후 결과는 나중에 보여줘도 되는 케이스

### logging Pipeline

Log Write to File -> File Scraping -> Pileline ... -> Indexing ... -> Kibana(Elastic Search)

### xx 페이 내 "대출 가능 여부" 조회 플랫폼

- 인증
- 각 기관들에서 대출 가능 여부를 확인하고 있는 중이에요, 완료되면 알림톡을 보내드릴께요 ~
- 완료 이벤트를 수신하여 XX 톡 발송 // 이후 중요한 정보를 관리하는 외부 기관 프로세싱 수행 등

> 대출 가능 프로세스 는 내가 어떻게 해볼 수 있는게 아닐것이다.
> - 왜냐하면 대출가능 인증 여부를 확인하다가 고객이 이탈할 수도 있기 때문에 치명적으로 올 수 있을 것 이다.
> - 외부 기관 들에 프로세싱까지 어떻게 해볼 수 있는게 아닐것이기 때문이다.
> - 이를 줄이려면 비동기 통신이 적절 할 수 있는 비즈니스 일 것이다.

#### Q 상황

- 두번 이상 수신되는 것이 문제
- 중요한 비즈니스에서도 리소스 활용을 최적화 하고 싶어요

#### 2번 이상 수신되어도, 괜찮을 수 있는 방법이 없을까 ?

- -> 멱등성 (Idempotent) 이 필요한 상황 식별!

멱등성이 무엇인가요 ?

- 간단히 말해서, 특정 호출이 1번 혹은 여러번 호출되어도 서버의 상태는 1번 호출된 것과 동일해야 한다 라는 특성!

일반적으로 Update, Delete 요청은 멱등성을 가지며, Create 요청은 멱등성을 가지지 않아요.
-> Sync 통신에서는 멱등성을 Business Logic 으로 구현해요.

### Async 통신에서의 멱등성

Async 통신에서는 기본적으로 멱등성이 보장되지 않는 통신 방식이다.
그럼에도 멱등성을 구현하기 위해서는, "다른 무언가" 가 필요하다.

"멱등성" 구현을 위한 DB Table(RDB) 를 사용해서 멱등성을 구현할 수 있다.

- Queue_log
    - message_id -> 특정 큐잉 메세지의 고유 식별자
    - status -> 메세지의 상태 (대기중, 처리중, 완료)
    - created_timestamp -> Producer 로부터 메세지가 큐에 추가된 시간
    - processed_timestamp -> Consumer 로부터 메세지가 큐에서 처리된 시간
    - processed_status -> Consumer 로부터 처리된 메세지의 결과 (성공, 실패)

# 멱등성이 구현된 Producer, Consumer

### 멱등성 구현 이전,

- Producer 는 항상 메세지를 생성하여 큐에 추가하고, Consumer 는 항상 메세지를 처리해요

### 멱등성 구현 이후,

Message Produce 시

- Produce 전에, queue_log 테이블에 동일한 message_id 가 존재하는지 확인
- 존재할 경우, 이미 수행되었으므로 에러/스킵 처리
- 존재하지 않을 경우, 새로운 메세지들 큐에 수가

Message Consume 시,

- Consume 전에, queue_log 테이블에서 message_id 의 상태를 확인
    - 처리된 경우 혹은 처리중인 status 인 경우, 중복 처리로 간주하여 에러/스킵 처리
    - 처리되지 않은 경우, message_id 의 status 값을 처리중으로 변경 후에 메세지 처리
    - 성공 시, processed_status 값을 처리 성공으로 처리
    - 실패 시, processed_status 값을 처리실패로 처리

### 멱등성이 구현된 메세징 솔루션

멱등성이 워낙 중요므로, 여러 메세징 오픈소스에서도 기능을 내장하는 경우가 있다.

하지만, 앞에서 기본적으로 메세지 (큐잉) 은 멱등성을 보장하지 않는다.
즉, 기능을 제공한다는 얘기는 멱등성 보장 프로세스를 내장하고 있다는것.
당연히 사용하지 않는 것에 비해서는 퍼포먼스 적인 차이가 존재하게됨.

단순히 Exactly Once 를 지원한다 가 아니라, 내부적으로는 이런식으로 동작하겠네 가 중요하다.

> 현상을 그대로 받아들이는 것이 아니라, 왜 이런기능들이 나오게 되었는지 생각을 해보는것이 중요하다.