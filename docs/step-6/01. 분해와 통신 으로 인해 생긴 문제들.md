# 분해, 통신, 그리고 다양한 기교

### 아래와 같은 4개의 서비스 가 있다고 가정해보자. 
- 송금 서비스 
- 뱅킹서비스
- 머니 서비스
- 멤버십

### 상황 1
1. 멤버십 조회 (회원임을 확인)
2. 송금 서비스에서 머니를 조회 (얼마가 있는지)
3. 돈이 부족해 뱅킹서비스 ( FirmBanking ) 에 충전 요청
4. 머니서비스 에 충전 한 금액을 write ! ( 이때 트랜젝션 오류 가 발생)

### 트랜젝션 오류가 발생했을때 어떤 전략들이 있을까
- MSA 에서 트랜잭션은 어떻게 처리할까 ? 
  - 단순 Sync 방식 재시도
  - DB 에 상태 저장 후, 비동기 방식 재시도
  - Async 방식으로 Dead Letter 처리
  - ...

### MSA 에서 ...
- 분해와 통신 은 필수
  - 트랜잭션 은 어떻게 해야하는가 ? 
    - 어떤 패턴을 쓰면 된데 !!! <- 할 수 도 있고 
    - 재시도 한다던가
    - Dead Letter Queue 처리 할 수 있고
    - 단순 Sync 방식으로 재시도 처리 해도 되고 
    - DB 에 특정 플래그를 update 해두고, Batch 를 돌릴 수도 있는것이고 ...
  - 한번쯤은 심도 있게 고려 해보자.

### 기교가 통하지 않을 수 있는 케이스 ( 엄밀히 말하면 트랜잭션 구현이 필요한 경우 )
- 인프라가 적절히 존재하지 않을경우
- 전 비즈니스에서 트랜잭션에 대한 강한 니즈가 있는 경우
- 너무나 Risky (중요한) 비즈니스 인 경우 (e.g 금융) // 외부 의존성 (시스템) 에 제약 사항이 있을 경우 ( e.g 재시도 할 수 없는 외부 시스템의 경우)
- 외부 은행이 특정 ID 에 대해 2번 이상 받아주지 않는다면 ?

### 트랜잭션을 구현할 만한 상황에서 구현한다.
- 기교만으로 해결된다 ? 트랜잭션 적용 안하는게 낫다.
- why ? 어렵다.
  - 보상 트랜잭션 ( SAGA 패턴 )
  - 관리 포인트가 너무나 많이 늘어나게 된다.
  - 개발에 필요한 시간이 훨씬 더 많이 늘어난다.
  - MSA 의 목절에 주객이 전도되는 현상이 발생할 수 있다.

---

### 트랜잭션 (Transaction) 과 ACID
- 트랜잭션은 무었을 만족해야 할까 ? 
- 일련의 작업들을 atomic 하게 수행하는 작업의 단위
- ACID 란 트랜잭션이 만족시켜야 하는 4가지 속성
  - Atomicity (원자성)
    - 전체가 수행되거나, 혹은 수행되지 않거나의 특성을 가져야 한다.
    - 어느 하나라도 실패하면, 이전에 수행된 변경 사항들은 Rollback 과정이 필요하다.
  - Consistency (일관성)
    - 트랜잭션 실행 전과 실행 후에, 변경되는 데이터들은 일관성을 유지해야 한다.
    - 즉, 도메인, 비즈니스에 따라 약속된 데이터의 변경들만 이루어 져야 한다. ( 데이터 정합성 유지 )
  - Isolation (고립성)
    - 트랜잯션 간에는, 서로 영향이 미치면 안된다.
  - Durabillity (지속성)
    - 트랜잭션 완료 후, 그 결과는 영구적으로 유지 되어야 한다.

### 분산 시스템 환경에 서 트랜잭션을 유지하기 위한 방안들
- n Phase Commit
  - 2단계 커밋
  - 3단계 커밋
- 보상 트랜잭션 - Compensate Transaction'
- Saga Pattern ( 2PC + 보상 트랜잭션 )
